<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FTT Big List</title>

  <!-- Performance hints -->
  <link rel="preconnect" href="https://unavatar.io" crossorigin>
  <link rel="preconnect" href="https://www.google.com" crossorigin>
  <link rel="preconnect" href="https://images.weserv.nl" crossorigin>
  <link rel="dns-prefetch" href="//unavatar.io">
  <link rel="dns-prefetch" href="//images.weserv.nl">
  <link rel="dns-prefetch" href="//www.google.com">

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    :root{
      --brand:#0078d7;
      --bg:#ecf7ff;
      --panel:#fff;
      --text:#222;
      --line:#e9eef4;
      --line-2:#e0e6ee;
      --accent:#0063b1;
      --state:#0a2236;
    }
    body {
      margin: 0;
      background:
        radial-gradient(circle at 0 0, #ffffff 0, #ffffff 24px, transparent 24px),
        radial-gradient(circle at 24px 24px, #dfefff 0, #dfefff 24px, transparent 24px),
        linear-gradient(#d6ecff, #ecf7ff);
      background-size: 48px 48px, 48px 48px, auto;
      background-position: 0 0, 0 0, 0 0;
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }

    header {
      display: grid;
      gap: 8px;
      padding: 10px 12px 12px;
      color: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,.18);
      position: relative;
      overflow: hidden;
      background:
        linear-gradient(135deg, rgba(0,120,215,0.95), rgba(0,120,215,0.88)),
        linear-gradient(#ffffff1a 1px, transparent 1px),
        linear-gradient(90deg,#ffffff1a 1px, transparent 1px);
      background-size: auto, 28px 28px, 28px 28px;
      background-position: 0 0, 0 0, 0 0;
    }
    /* Subtle "bubbles"/steam overlay for bathroom vibe */
    header::after{
      content:"";
      position:absolute;
      inset:-40px;
      pointer-events:none;
      background:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,0.18) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.16) 0, transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(255,255,255,0.10) 0, transparent 60%);
      opacity:0.9;
      mix-blend-mode: screen;
    }

    header .top {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    h1 {
      margin:0;
      font-size:15px;
      font-weight:800;
      line-height:1.1;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    h1::before{
      content:"üöΩ";
      display:inline-block;
      font-size:18px;
    }

    .top-right{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
      flex-wrap:wrap;
    }

    .meta {
      margin-left:0;
      font-size:12px;
      opacity:.95;
      background: #ffffff1a;
      padding:4px 8px;
      border-radius:999px;
      backdrop-filter: blur(4px);
      border:1px solid rgba(255,255,255,0.35);
    }

    .button-row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      position:relative;
      z-index:1;
      margin-left: 18px;
    }
    .btn {
      color:#fff;
      background:#0063b1;
      border:0;
      border-radius:999px;
      padding:.40rem .75rem;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition:transform .05s ease, filter .2s ease, box-shadow .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.18);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.us{background:#0078d7}
    .btn.canada{background:#d83b01}
    .btn.samerica{background:#107c10}
    .btn.europe{background:#6b46c1}
    .btn.eastasia{background:#e81123}
    .btn.mideast{background:#ffb900;color:#333}
    .btn.active{
      outline:2px solid #fff;
      outline-offset:1px;
      filter:brightness(1.06);
      box-shadow:0 0 0 2px rgba(0,0,0,0.15);
    }
    .btn.submit{ background:#9c27b0; }
    .btn.reddit{ background:#ff4500; }
    .btn.download { background:#1f7a1f; }
    .btn.small{
      font-size:12px;
      padding:.25rem .55rem;
      border-radius:999px;
    }

    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      font-size:12px;
      justify-content:flex-start;
      position:relative;
      z-index:1;
    }
    .controls input[type="search"]{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #c8d7eb;
      min-width:260px;
      outline: none;
      background:#fdfefe;
    }
    .controls .btn {
      font-size:12px;
      padding:.45rem .65rem;
      border-radius:999px;
      border:none;
    }

    .consent-bar{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
      font-size:11px;
      color:#e6f2ff;
      position:relative;
      z-index:1;
    }
    .consent-bar span{
      opacity:0.95;
    }
    .consent-bar a{
      color:#fff;
      font-weight:600;
      text-decoration:underline;
    }

    main { display:flex; flex-direction:column; }

    .table-wrap {
      height: calc(100vh - 224px);
      overflow:auto;
      background:var(--panel);
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
    }

    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      table-layout: fixed;
      font-size: 14px;
      min-width: 2200px;
    }
    tbody td {
      border-bottom:1px solid #f0f3f6;
      padding:8px 10px;
      vertical-align: top;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: normal;
      hyphens: manual;
      line-height:1.35;
      background: var(--panel);
    }
    tbody tr:nth-child(2n){ background:#fafcff; }

    tbody tr.is-hidden { display: none; }
    tbody tr.sticky-second td {
      position: sticky;
      top: 0;
      z-index: 4;
      background: linear-gradient(#f7fafc, #eef3f9);
      border-bottom: 2px solid var(--line-2);
    }

    .sticky-second .hdr-sort {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      padding:2px 4px;
      border-radius:8px;
    }
    .sticky-second .hdr-sort:hover { background:#e9eef7; }
    .sort-caret{ font-size:12px; opacity:.75; }
    .sorted-asc .sort-caret::after{ content:"‚ñ≤"; }
    .sorted-desc .sort-caret::after{ content:"‚ñº"; }
    .sorted-none .sort-caret::after{ content:"‚Üï"; opacity:.5; }

    tr.state-header > td {
      background: var(--state) !important;
      color:#fff !important;
      font-weight: 800;
      letter-spacing: .2px;
      border-bottom: 2px solid #111;
      position: sticky;
      top: 40px;
      z-index: 3;
    }
    tr.state-header .state-bar {
      display:flex;
      align-items:center;
      gap:10px;
      cursor: pointer;
      padding:6px 0;
    }
    .chev {
      width: 0;
      height: 0;
      border-left: 6px solid currentColor;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      transition: transform .15s ease;
    }
    .expanded .chev { transform: rotate(90deg); }
    tr[data-collapsed="true"] { display: none; }

    .imgCol { width: 160px; }
    .thumb  {
      width: 120px;
      height: 120px;
      border-radius:12px;
      border:1px solid #ececec;
      object-fit:cover;
      display:block;
      background:#f1f1f1;
    }
    .skeleton {
      width: 120px;
      height: 120px;
      background:linear-gradient(90deg,#eee,#f5f5f5,#eee);
      background-size:200% 100%;
      animation:shimmer 1s linear infinite;
      border-radius:12px;
      border:1px solid #ececec;
    }
    @keyframes shimmer{0%{background-position:0% 0}100%{background-position:200% 0}}
    .hide-images .imgCol { display:none; }

    td a {
      white-space: nowrap;
      display:inline-block;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cell-link { color: inherit; text-decoration: underline; }
    .full-url {
      display:none;
      margin-top:6px;
      font-size:12px;
      color:#333;
      word-break: break-all;
      white-space: normal;
      background:#f6f8fb;
      border:1px solid #e5ebf3;
      border-radius:8px;
      padding:6px;
    }
    .show-full .full-url { display:block; }

    .clamp-wrap { display:-webkit-box; -webkit-box-orient:vertical; overflow:hidden; }
    .clamp-3 { -webkit-line-clamp:3; }
    .clamp-5 { -webkit-line-clamp:5; }
    .moreless {
      display:inline-block;
      margin-top:6px;
      font-size:12px;
      color:var(--accent);
      cursor:pointer;
      user-select:none;
    }

    .search-row-hide { display: none !important; }

    .sentiment { font-size:18px; line-height:1; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      text-decoration:none;
      color:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,0.18);
      white-space:nowrap;
    }
    .pill.blue{ background:#4da3ff; }
    .pill.green{ background:#2e9e4f; }
    .pill.brown{ background:#8b5a2b; }
    .pill.orange{ background:#ff4500; }
    .pill.red{ background:#d32f2f; color:#fff; }
    .pill.dark-red{ background:#941212; color:#fff; }

    .footer-actions{
      padding:8px 12px;
      display:flex;
      gap:8px;
      align-items:center;
      color:#4b5563;
      font-size:12px;
      flex-wrap: wrap;
      background:rgba(255,255,255,0.8);
      backdrop-filter: blur(3px);
    }

    .footer-tabs-row{
      width:100%;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      padding-top:10px;
      margin-top:6px;
      border-top:1px solid var(--line-2);
    }
    .footer-tabs-row .btn{
      background:#f7fafc;
      color:#0a2236;
      border:1px solid var(--line-2);
      box-shadow:0 1px 2px rgba(0,0,0,0.12);
      border-radius:12px;
      padding:.55rem .95rem;
      font-weight:700;
    }
    .footer-tabs-row .btn:hover{
      filter:brightness(0.98);
    }
    .footer-tabs-row .btn:active{
      transform:translateY(1px);
    }
    .linkish{ color:#0a5a7a; cursor:pointer; text-decoration:underline; }

    .footer-consent{
      padding:0 12px 10px;
      font-size:11px;
      line-height:1.4;
      color:#4b5563;
      max-width:760px;
    }
    .footer-consent a{
      color:#0a5a7a;
      font-weight:600;
      text-decoration:underline;
    }

    .price-badge{
      display:inline-block;
      font-size:12px;
      margin-left:6px;
      padding:2px 6px;
      border-radius:8px;
      background:#eef4ff;
      border:1px solid #d9e5ff;
      white-space:nowrap;
    }

    /* stacked mini-profile blocks */
    .stack-block{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:13px;
    }
    .stack-line{
      display:flex;
      gap:4px;
      align-items:flex-start;
    }
    .stack-label{
      font-weight:600;
      white-space:nowrap;
    }
    .stack-value{
      flex:1 1 auto;
      min-width:0;
    }
    .stack-muted{
      font-size:12px;
      opacity:0.8;
    }

    .svc-tag{
      display:inline-block;
      padding:2px 4px;
      margin:0 2px 2px 0;
      border-radius:4px;
      border:1px solid #d1d5db;
      background:#f3f4f6;
      font-size:11px;
    }

    /* Verified emoji row so icons sit above the text */
    .verified-emoji-row{
      font-size:1.8em;
      line-height:1.1;
      margin-bottom:2px;
    }
  </style>
</head>
<body>
  <header>
    <div class="top">
      <h1>FTT Big List</h1>

      <div class="top-right">
        <div class="meta" id="meta">loading‚Ä¶</div>
        <a
          class="btn submit"
          href="https://docs.google.com/forms/d/e/1FAIpQLSfbY17FJMkIvTPIjQZjXYT1MXEdWGb4bFCiB3A_Pq2Smpoq2Q/viewform?usp=header"
          target="_blank"
          rel="noopener"
        >
          Submit to list
        </a>
        <a
          class="btn reddit"
          href="https://www.reddit.com/r/FullToiletMistresses/"
          target="_blank"
          rel="noopener"
        >
          Reddit
        </a>
      </div>
    </div>

    <div class="button-row" role="navigation" aria-label="Tabs">
      <button class="btn us active"      data-gid="0">United States</button>
      <button class="btn canada"         data-gid="918890863">Canada</button>
      <button class="btn samerica"       data-gid="506975496">South America + Caribbean</button>
      <button class="btn europe"         data-gid="1560092023">Europe + Nordic</button>
      <button class="btn eastasia"       data-gid="1966795654">East Asia + Oceania + Australia</button>
      <button class="btn mideast"        data-gid="1604960979">Middle East</button>
    </div>

    <div class="controls">
      <input id="searchBox" type="search" placeholder="Search‚Ä¶" />
      <button id="clearSearch" class="btn" style="background:#666">Clear</button>

      <label class="switch" title="Toggle row thumbnails">
        <input id="imgToggle" type="checkbox" />
        Show images
      </label>

      <button id="expandAll" class="btn" style="background:#3aa655">Expand all</button>
      <button id="collapseAll" class="btn" style="background:#b83d3d">Collapse all</button>
    </div>

    <div class="consent-bar">
      <span>Consent is important. To add, update, or remove an entry, please use the community input form:</span>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSfbY17FJMkIvTPIjQZjXYT1MXEdWGb4bFCiB3A_Pq2Smpoq2Q/viewform?usp=header" target="_blank" rel="noopener">
        Open community form
      </a>
    </div>
  </header>

  <main>
    <div class="table-wrap" id="scrollWrap">
      <table id="tbl" aria-live="polite">
        <colgroup id="colg"></colgroup>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="footer-actions">
      <span class="linkish" id="resetSort">Reset sorting</span>
      <button id="downloadCsvBtn" class="btn download">‚¨áÔ∏è Download CSV</button>

      <a
        class="btn submit"
        href="https://docs.google.com/forms/d/e/1FAIpQLSfbY17FJMkIvTPIjQZjXYT1MXEdWGb4bFCiB3A_Pq2Smpoq2Q/viewform?usp=header"
        target="_blank"
        rel="noopener"
      >
        Submit to list
      </a>
        <a
          class="btn reddit"
          href="https://www.reddit.com/r/FullToiletMistresses/"
          target="_blank"
          rel="noopener"
        >
          Reddit
        </a>
        <div class="footer-tabs-row" role="navigation" aria-label="Tabs (footer)">
        <button class="btn us"      data-gid="0">United States</button>
        <button class="btn canada"         data-gid="918890863">Canada</button>
        <button class="btn samerica"       data-gid="506975496">South America + Caribbean</button>
        <button class="btn europe"         data-gid="1560092023">Europe + Nordic</button>
        <button class="btn eastasia"       data-gid="1966795654">East Asia + Oceania + Australia</button>
        <button class="btn mideast"        data-gid="1604960979">Middle East</button>
      </div>
    </div>

    <div class="footer-consent">
      Consent is important. If you are on the list and want to be removed, please
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSfbY17FJMkIvTPIjQZjXYT1MXEdWGb4bFCiB3A_Pq2Smpoq2Q/viewform?usp=header" target="_blank" rel="noopener">
        fill out this form
      </a>
      and contact the mods at
      <a href="https://www.reddit.com/r/FullToiletMistresses" target="_blank" rel="noopener">
        r/FullToiletMistresses
      </a>
      on Reddit.
    </div>
  </main>

  <script>
  /** ==== CONFIG ==== */
  const FILE_ID = "1hse75kxI9Gcb7g_tc9LOZ5dYVkFgDcNCrLKyq03cnHg";
  let   GID     = "0";
  const RANGE   = "A1:AA50000";
  const MAX_SHOW_COL_LETTER = "S";
  const MAX_SHOW_COL_IDX = colLetterToIdx(MAX_SHOW_COL_LETTER);

  const TABS = [
    { name: "United States", gid: "0" },
    { name: "Canada", gid: "918890863" },
    { name: "South America + Caribbean", gid: "506975496" },
    { name: "Europe + Nordic", gid: "1560092023" },
    { name: "East Asia + Oceania + Australia", gid: "1966795654" },
    { name: "Middle East", gid: "1604960979" },
  ];

  const ACTIVE_GID_KEY = "ftt-active-gid";
  const SCROLL_KEY_PREFIX = "ftt-scroll:"; // + GID
  const SORT_KEY_PREFIX   = "ftt-sort:";   // + GID

  /* Base column indices (A=0) ‚Äì will get refined dynamically from header row */
  let LOC_COL_IDX = 0;
  let ALT_LOC_COL_IDX = 1;
  let DOMME_COL_IDX = 2;
  let ALIAS_COL_IDX = 3; // "Images/Aliases"
  let E_COL_IDX = 4; // Website
  let F_COL_IDX = 5; // Link tree/All links
  let G_COL_IDX = 6; // X/BlueSky
  let H_COL_IDX = 7; // Verified?
  let I_COL_IDX = 8; // Experience?
  let J_COL_IDX = 9; // Price range?
  let REVIEW_COL_IDX = 10; // Review/notes
  let RENOWN_COL_IDX = 11; // Renown
  let FULL_REVIEW_COL_IDX = 12; // Link to full review
  let TRAVELS_COL_IDX = 13; // Travels?
  let EMAIL_COL_IDX = 14; // email
  let P_COL_IDX = 15; // Reddit
  let Q_COL_IDX = 16; // phone
  let SERVICES_COL_IDX = 17; // Services Provided
  let GENDER_COL_IDX = -1; // will be detected
  let SCAT_COL_IDX = -1;
  let FETLIFE_COL_IDX = -1;
  let WHATSAPP_COL_IDX = -1;

  /* Wider/watched columns */
  const WIDE_COLS = ["E","K","R"];
  const WIDE_IDX  = WIDE_COLS.map(colLetterToIdx);

  /* Image pref column (V) */
  const IMAGE_PREF_COL_LETTER = "V";
  const IMAGE_PREF_COL_IDX = colLetterToIdx(IMAGE_PREF_COL_LETTER);

  /* Sortable header labels on the sticky header row */
  const SORTABLE_HEADERS = new Map([
    ["Location","A"],
    ["Alternative Location","B"],
    ["Domme","C"],
    ["Verified?","H"],
    ["Experience?","I"],
    ["Price range?","J"],
  ]);

  let POLL_MS = 120000;
  let ROW_CAP = 2000;
  const THUMB_PX = 120;

  const MAX_CONCURRENT_IMG = 8;
  const IMG_TIMEOUT_MS = 3000;
  const LAZY_ROOT_MARGIN = '1200px 0px';

  const COL_HEADERS = [
    "Location","Alternative Location","Domme","Images/Aliases","Website","Link tree/All links",
    "X/BlueSky","Verified?","Experience?","Price range?","Review/notes","Renown",
    "Link to full review","Travels?","email","Reddit","phone","Services Provided","link"
  ];

  const SERVICE_KEYWORDS = [
    "Full toilet",
    "Brown showers",
    "Golden showers",
    "Ruby Showers",
    "Roman showers",
    "Full toilet training",
    "toilet training",
    "Double sessions",
    "Toilet chair",
    "Bondage",
    "Couples",
    "LGBTQ friendly",
    "Impact play",
    "Strapon"
  ];

  /** ==== DOM ==== */
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const tbody = $("#tbody");
  const colg  = $("#colg");
  const meta  = $("#meta");
  const imgToggle = $("#imgToggle");
  const expandAllBtn = $("#expandAll");
  const collapseAllBtn = $("#collapseAll");
  const searchBox = $("#searchBox");
  const clearSearchBtn = $("#clearSearch");
  const resetSortBtn = $("#resetSort");
  const downloadCsvBtn = $("#downloadCsvBtn");
  const scrollWrap = $("#scrollWrap");

  /** ==== State ==== */
  let currentRows = [];
  let currentColCount = 0;
  let sortSpec = null; // { colIdx, dir: 'asc'|'desc' }
  let lastQuery = "";
  let imgCandCache = new Map();
  let rowTextIndex = new Map();

  /** ==== Concurrency limiter for images ==== */
  let inflight = 0;
  const pendingStarts = [];
  function schedule(startFn){
    if (inflight < MAX_CONCURRENT_IMG){ inflight++; startFn(); }
    else { pendingStarts.push(startFn); }
  }
  function doneOne(){
    inflight = Math.max(0, inflight - 1);
    if (pendingStarts.length){ const fn = pendingStarts.shift(); inflight++; fn(); }
  }

  /** ==== Lazy image observer ==== */
  const lazyImgObserver = new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      if (!entry.isIntersecting) return;
      const starter = entry.target._startLoading;
      if (starter) schedule(starter);
      lazyImgObserver.unobserve(entry.target);
    });
  }, { root: scrollWrap, rootMargin: LAZY_ROOT_MARGIN, threshold: 0.01 });

  /** ==== Utilities ==== */
  function colLetterToIdx(letter){ let n=0; for(let i=0;i<letter.length;i++) n=n*26+(letter.charCodeAt(i)-64); return n-1; }
  const URL_RE = /(https?:\/\/[^\s)'"<>]+)/i;
  const IMG_EXT_RE   = /\.(png|jpe?g|gif|webp|avif|svg)(\?.*)?$/i;
  const IMG_HOST_HINT= /(twimg\.com|fbcdn\.net|cdn|images|media|imgur|ggpht\.com|pinimg\.com)/i;
  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
  function csvEscape(v){ const s=(v??"").toString().replace(/\r?\n/g," ").trim(); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
  function downloadCSV(filename, rows){
    const csv = "\uFEFF" + rows.map(r => r.map(csvEscape).join(",")).join("\r\n");
    const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
  function norm(s){ return (s||"").toString().trim().toLowerCase(); }

  function extractNumbers(s){
    if (!s) return [];
    const m = String(s).replace(/,/g,'').match(/\d+(\.\d+)?/g);
    return m ? m.map(Number) : [];
  }
  function computePriceNumber(s){
    const nums = extractNumbers(s);
    if (!nums.length) return NaN;
    if (nums.length === 1) return nums[0];
    return nums.reduce((a,b)=>a+b,0) / nums.length;
  }
  function prettyUrlText(url){
    const fallback = (s) => String(s)
      .replace(/^https?:\/\//i,'')
      .replace(/^www\./i,'')
      .replace(/\/+$/,'');
    try {
      const u = new URL(url);
      const host = (u.hostname || "").replace(/^www\./i,'');
      const rawPath = (u.pathname || "").replace(/\/+$/,'');
      if (!rawPath || rawPath === "/") return host;
      const parts = rawPath.split('/').filter(Boolean);
      const usernameHosts = /^(allmylinks\.com|linktr\.ee|beacons\.ai|carrd\.co|stan\.store|onlyfans\.com|fansly\.com|manyvids\.com|patreon\.com|ko-fi\.com)$/i;
      const usernameLike = /^[A-Za-z0-9._-]{2,}$/;
      if (usernameHosts.test(host)) {
        return `${host}/${parts[0]}`;
      }
      if (parts.length === 1 && usernameLike.test(parts[0])) {
        return `${host}/${parts[0]}`;
      }
      if (parts.length === 2 && usernameLike.test(parts[0]) && parts[1].length <= 20) {
        return `${host}/${parts[0]}/${parts[1]}`;
      }
      const last = parts[parts.length - 1];
      return `${host}/‚Ä¶/${last}`;
    } catch {
      return fallback(url);
    }
  }

  function priceRank(s){
    const t = norm(s);
    if (!t || t.includes("unknown")) return Number.POSITIVE_INFINITY;
    const hasLow = t.includes("low");
    const hasMid = t.includes("mid");
    const hasHighMid = t.includes("high mid") || t.includes("high-mid") || t.includes("mid high") || t.includes("mid-high");
    const hasHigh = t.includes("high");
    if (hasLow && !hasMid) return 0;
    if (hasLow && hasMid)  return 1;
    if (!hasLow && hasMid && !hasHighMid) return 2;
    if (hasHighMid) return 3;
    if (hasHigh) return 4;
    return 5;
  }

  function verifiedRank(s){
    const t = norm(s);
    if (!t) return 9;
    if (t.includes("scam")) return 8;
    if (t.includes("admin verified")) return 0;
    if (t.includes("reddit verified")) return 1;
    if (t.includes("fetlife verified")) return 2;
    if (/\bverified\b/.test(t)) return 3;
    if (t.includes("needs verification")) return 5;
    if (t.includes("mixed")) return 6;
    if (t.includes("seems legit")) return 4;
    return 7;
  }

  function experienceRank(s){
    const t = norm(s);
    if (!t) return 6;
    if (t.includes("positive")) return 0;
    if (t.includes("neutral"))  return 1;
    if (t.includes("mixed"))    return 2;
    if (t.includes("needs review")) return 3;
    if (t.includes("negative")) return 4;
    return 5;
  }

  function firstUrl(text){ const m=(text||"").match(URL_RE); return m?m[1]:""; }
  function preferredLandingUrl(row){ return firstUrl(row[E_COL_IDX]) || firstUrl(row[G_COL_IDX]) || ""; }
  function isOnlyColAText(row){
    const colA = (row[0] || "").trim(); if (!colA) return false;
    for (let i=1;i<row.length;i++) if ((row[i]||"").trim()!=="") return false; return true;
  }

  function imageCacheKey(row){
    const v = (row[21]||""); const g = (row[G_COL_IDX]||""); const e = (row[E_COL_IDX]||"");
    return `ftt-imgcache:${GID}:${v}|${g}|${e}`;
  }
  function cacheGetGoodSrc(row){ try { return localStorage.getItem(imageCacheKey(row)) || ""; } catch { return ""; } }
  function cacheSetGoodSrc(row, rawUrl){ try { localStorage.setItem(imageCacheKey(row), rawUrl); } catch {} }

  function extractDomain(url) { try { return new URL(url).hostname; } catch { return ""; } }
  function isTwitterDomain(host){ return /(^|\.)x\.com$/.test(host) || /(^|\.)twitter\.com$/.test(host); }
  function unavatarForDomain(domain) { return domain ? `https://unavatar.io/${encodeURIComponent(domain)}?fallback=false` : ""; }
  function faviconForDomain(domain) { return domain ? `https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=128` : ""; }
  function unavatarForTwitterHandleStrict(txt) {
    const at = (txt || "").trim(); if (!/^@[\w.]{1,50}$/i.test(at)) return [];
    const h = at.slice(1);
    return [
      `https://unavatar.io/x/${encodeURIComponent(h)}?fallback=false`,
      `https://unavatar.io/twitter/${encodeURIComponent(h)}?fallback=false`
    ];
  }
  function extractTwitterHandleFromUrlish(txt){
    const m = (txt || "").match(URL_RE); if (!m) return "";
    try {
      const u = new URL(m[1]); if (!isTwitterDomain(u.hostname)) return "";
      const parts = u.pathname.split('/').filter(Boolean);
      const handle = parts[0] || "";
      if (/^[A-Za-z0-9_]{1,50}$/.test(handle)) return `@${handle}`;
    } catch {}
    return "";
  }
  function unavatarForUrlishSkippingTwitter(txt){
    const m = txt && txt.match(URL_RE); if (!m) return "";
    const host = extractDomain(m[1]); if (!host || isTwitterDomain(host)) return "";
    return unavatarForDomain(host);
  }
  function faviconForUrlishSkippingTwitter(txt){
    const m = txt && txt.match(URL_RE); if (!m) return "";
    const host = extractDomain(m[1]); if (!host || isTwitterDomain(host)) return "";
    return faviconForDomain(host);
  }

  function imageCandidates(row){
    const cached = cacheGetGoodSrc(row); const out = []; if (cached) out.push(cached);
    if (IMAGE_PREF_COL_IDX >= 0 && IMAGE_PREF_COL_IDX < row.length) {
      const vtxt = row[IMAGE_PREF_COL_IDX] || ""; const vm = vtxt.match(URL_RE);
      if (vm) {
        const v = vm[1];
        if (IMG_EXT_RE.test(v) || IMG_HOST_HINT.test(v)) out.push(v);
        else {
          const genV = unavatarForUrlishSkippingTwitter(vtxt) || faviconForUrlishSkippingTwitter(vtxt);
          if (genV) out.push(genV);
        }
      }
    }
    const gStrict = unavatarForTwitterHandleStrict(row[G_COL_IDX])
      .concat(unavatarForTwitterHandleStrict(extractTwitterHandleFromUrlish(row[G_COL_IDX])));
    if (gStrict.length) out.push(...gStrict);
    const gGen = unavatarForUrlishSkippingTwitter(row[G_COL_IDX]) || faviconForUrlishSkippingTwitter(row[E_COL_IDX]); if (gGen) out.push(gGen);
    const eGen = unavatarForUrlishSkippingTwitter(row[E_COL_IDX]) || faviconForUrlishSkippingTwitter(row[E_COL_IDX]); if (eGen) out.push(eGen);
    for (const cell of row) {
      if (!cell) continue; const m = cell.match(URL_RE); if (!m) continue;
      const url = m[1]; if (IMG_EXT_RE.test(url) || IMG_HOST_HINT.test(url)) out.push(url);
    }
    const seen = new Set(); return out.filter(u => { if (seen.has(u)) return false; seen.add(u); return true; });
  }
  function proxify(url){
    try { const noScheme = url.replace(/^https?:\/\//i,""); return `https://images.weserv.nl/?url=${encodeURIComponent(noScheme)}&w=${THUMB_PX}&h=${THUMB_PX}&fit=cover&q=70`; }
    catch { return url; }
  }

  function loadCollapseState(gid){ try { return JSON.parse(localStorage.getItem(`ftt-collapse:${gid}`)) || {}; } catch { return {}; } }
  function saveCollapseState(gid, map){ try { localStorage.setItem(`ftt-collapse:${gid}`, JSON.stringify(map)); } catch {} }
  function loadShowImages(){ try { const v=localStorage.getItem("ftt-show-images"); return v===null?true:v==="true"; } catch { return true; } }
  function saveShowImages(flag){ try { localStorage.setItem("ftt-show-images", String(flag)); } catch {} }
  function persistSort(gid, spec){ try { localStorage.setItem(SORT_KEY_PREFIX + gid, JSON.stringify(spec||null)); } catch {} }
  function loadSort(gid){ try { const v=localStorage.getItem(SORT_KEY_PREFIX + gid); return v?JSON.parse(v):null; } catch { return null; } }

  function comparator(colIdx, dir){
    const mul = (dir === "desc") ? -1 : 1;
    return (ai, bi) => {
      const a = (currentRows[ai] && currentRows[ai][colIdx] || "");
      const b = (currentRows[bi] && currentRows[bi][colIdx] || "");
      if (colIdx === J_COL_IDX){
        const na = computePriceNumber(a), nb = computePriceNumber(b);
        const aValid = Number.isFinite(na), bValid = Number.isFinite(nb);
        if (aValid && bValid) return (na < nb ? -1 : na > nb ? 1 : 0) * mul;
        if (aValid && !bValid) return -1;
        if (!aValid && bValid) return 1;
        const ta = norm(a), tb = norm(b);
        if (ta < tb) return -1 * mul; if (ta > tb) return 1 * mul; return 0;
      }
      if (colIdx === H_COL_IDX){
        const scamA = norm(a).includes("scam"), scamB = norm(b).includes("scam");
        if (scamA && !scamB) return 1;
        if (scamB && !scamA) return -1;
        const ra = verifiedRank(a), rb = verifiedRank(b);
        if (ra !== rb) return (ra < rb) ? -1 : 1;
        const ta = norm(a), tb = norm(b);
        if (!ta && tb) return 1; if (!tb && a) return -1;
        if (ta < tb) return -1 * mul; if (ta > tb) return 1 * mul; return 0;
      }
      if (colIdx === I_COL_IDX){
        const ra = experienceRank(a), rb = experienceRank(b);
        if (ra !== rb) return (ra < rb) ? -1 : 1;
        const ta = norm(a), tb = norm(b);
        if (!ta && tb) return 1; if (!tb && a) return -1;
        if (ta < tb) return -1 * mul; if (ta > tb) return 1 * mul; return 0;
      }
      const ta = norm(a), tb = norm(b);
      if (!ta && tb) return 1;
      if (!tb && ta) return -1;
      if (ta < tb) return -1 * mul;
      if (ta > tb) return  1 * mul;
      return 0;
    };
  }

  function gvizURL(fileId, gid, range){
    const u = new URL(`https://docs.google.com/spreadsheets/d/${fileId}/gviz/tq`);
    u.searchParams.set("gid", gid);
    u.searchParams.set("range", range);
    u.searchParams.set("tqx", "out:json");
    u.searchParams.set("_", Date.now());
    return u.toString();
  }
  async function fetchRectFor(gid){
    const res  = await fetch(gvizURL(FILE_ID, gid, RANGE), { cache: "no-store" });
    const text = await res.text();
    const fixed = JSON.parse(text.replace(/^[^{]+/, "").replace(/[^}]+$/, ""));
    const rows = (fixed.table?.rows || []).map(r =>
      (r.c || []).map(cell => {
        if (!cell) return "";
        const v = (cell.f ?? cell.v);
        return v == null ? "" : String(v);
      })
    );
    const cols = (fixed.table?.cols || []);
    const colCount = Math.max(cols.length, ...rows.map(r => r.length), MAX_SHOW_COL_IDX+1, 0);
    rows.forEach(r => { while (r.length < colCount) r.push(""); });
    return { rows, colCount };
  }
  async function fetchRect(){ return fetchRectFor(GID); }

  function isHiddenColIndex(i){
    const idxs = [
      ALIAS_COL_IDX,
      GENDER_COL_IDX,
      F_COL_IDX,
      G_COL_IDX,
      SCAT_COL_IDX,
      FETLIFE_COL_IDX,
      RENOWN_COL_IDX,
      FULL_REVIEW_COL_IDX,
      TRAVELS_COL_IDX,
      P_COL_IDX,
      Q_COL_IDX,
      WHATSAPP_COL_IDX
    ].filter(x => x >= 0);
    return idxs.includes(i);
  }

  function buildColgroup(){
    colg.innerHTML = "";
    const widths = [160];
    for (let i=0;i<=MAX_SHOW_COL_IDX;i++){
      let w = 150;
      if (i < 3) w = 170;
      if (WIDE_IDX.includes(i)) w = 280;
      if (i === E_COL_IDX) w = 540;              // Links block
      if (i === EMAIL_COL_IDX) w = 320;          // Contact info
      if (i === SERVICES_COL_IDX) w = 420;       // Services Provided wider

      if (isHiddenColIndex(i)) w = 0;

      widths.push(w);
    }
    widths.forEach((px, idx) => {
      const col = document.createElement("col");
      if (px === 0) {
        col.style.width = "0px";
        col.style.display = "none";
      } else {
        col.style.width = px + "px";
      }
      colg.appendChild(col);
    });
  }

  function loadCollapseStateMap(){ return loadCollapseState(GID); }
  function buildGroups(rows){
    const state = loadCollapseStateMap();
    const groups = [];
    let current = null;
    for (let i=0; i<rows.length; i++){
      const row = rows[i];
      if (isOnlyColAText(row)) {
        const name = (row[0]||"").trim() || "Untitled";
        current = {
          headerIndex: i,
          stateName: name,
          stateNameLower: norm(name),
          members: [],
          collapsed: (state[name] !== undefined ? state[name] : true)
        };
        groups.push(current);
      } else if (current) {
        current.members.push(i);
      }
    }

    for (const g of groups) {
      g._memberSet = new Set(g.members);
    }

    if (ALT_LOC_COL_IDX >= 0) {
      for (const g of groups) {
        const originalMembers = [...g.members];
        for (const rIdx of originalMembers) {
          const row = rows[rIdx] || [];
          const alt = (row[ALT_LOC_COL_IDX] || "").trim();
          if (!alt) continue;
          const altLower = norm(alt);
          if (!altLower) continue;

          for (const target of groups) {
            if (target === g) continue;
            if (!target.stateNameLower) continue;
            if (!altLower.includes(target.stateNameLower)) continue;
            if (!target._memberSet.has(rIdx)) {
              target.members.push(rIdx);
              target._memberSet.add(rIdx);
            }
          }
        }
      }
    }

    return groups;
  }
  function persistGroups(groups){
    const map = {}; for (const g of groups) map[g.stateName] = g.collapsed; saveCollapseState(GID, map);
  }

  function makeTextCell(td, text, maxLines=3){
    const wrapper = document.createElement("div");
    wrapper.className = "clamp-wrap clamp-" + maxLines;
    wrapper.textContent = text ?? "";
    td.appendChild(wrapper);
    requestAnimationFrame(()=>{
      if (wrapper.scrollHeight > wrapper.clientHeight + 1) {
        const btn = document.createElement("span");
        btn.className = "moreless"; btn.textContent = " More";
        btn.addEventListener("click", ()=>{
          wrapper.classList.toggle("clamp-" + maxLines);
          btn.textContent = wrapper.classList.contains("clamp-" + maxLines) ? " More" : " Less";
        });
        td.appendChild(btn);
      }
    });
  }

  function buildServicesCell(td, text){
    const wrapper = document.createElement("div");
    wrapper.className = "clamp-wrap clamp-5";

    if (!text){
      wrapper.textContent = "";
      td.appendChild(wrapper);
      return;
    }

    const pattern = new RegExp(
      "(" + SERVICE_KEYWORDS
        .map(k => k.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\s+/g,"\\s+"))
        .join("|") + ")",
      "gi"
    );

    let lastIndex = 0;
    let m;
    while ((m = pattern.exec(text)) !== null) {
      if (m.index > lastIndex) {
        wrapper.appendChild(document.createTextNode(text.slice(lastIndex, m.index)));
      }
      const tag = document.createElement("span");
      tag.className = "svc-tag";
      tag.textContent = m[0];
      wrapper.appendChild(tag);
      lastIndex = pattern.lastIndex;
    }
    if (lastIndex < text.length) {
      wrapper.appendChild(document.createTextNode(text.slice(lastIndex)));
    }

    td.appendChild(wrapper);

    requestAnimationFrame(()=>{
      if (wrapper.scrollHeight > wrapper.clientHeight + 1) {
        const btn = document.createElement("span");
        btn.className = "moreless"; btn.textContent = " More";
        btn.addEventListener("click", ()=>{
          wrapper.classList.toggle("clamp-5");
          btn.textContent = wrapper.classList.contains("clamp-5") ? " More" : " Less";
        });
        td.appendChild(btn);
      }
    });
  }

  function linkifyWithMore(text, {alwaysShow=false, pretty=false} = {}){
    const m = text && text.match(URL_RE); if (!m) return null;
    const url = m[1]; const frag = document.createDocumentFragment();
    const a = document.createElement("a");
    a.href = url; a.target = "_blank"; a.rel = "noopener";
    a.textContent = pretty ? prettyUrlText(url) : text; a.className = "cell-link";
    frag.appendChild(a);
    if (alwaysShow || url.length > 60) {
      const btn = document.createElement("span"); btn.className = "moreless"; btn.textContent = " More";
      const wrap = document.createElement("div"); wrap.className = "full-url"; wrap.textContent = url;
      btn.addEventListener("click", ()=>{
        const td = btn.parentElement; td.classList.toggle("show-full");
        btn.textContent = td.classList.contains("show-full") ? " Less" : " More";
      });
      frag.appendChild(btn); frag.appendChild(wrap);
    }
    return frag;
  }
  function buildTwitterLinkFromHandle(txt){
    if (!txt) return null; const at = txt.trim(); if (!/^@[\w.]{1,50}$/i.test(at)) return null;
    const handle = at.slice(1); const a = document.createElement("a");
    a.href = `https://x.com/${handle}`; a.target = "_blank"; a.rel = "noopener"; a.textContent = at; a.className = "cell-link";
    return a;
  }
  function parseRedditUsername(raw) {
    if (!raw) return null; let s = String(raw).trim();
    s = s.replace(/^@/,'').replace(/^\/?u\//i,'').replace(/^u\//i,'');
    s = s.split(/\s+/)[0];
    if (!/^[A-Za-z0-9_]{2,25}$/.test(s)) return null; return s;
  }
  function buildRedditLink(raw){
    const user = parseRedditUsername(raw); if (!user) return null;
    const a = document.createElement("a");
    a.href = `https://www.reddit.com/user/${encodeURIComponent(user)}`; a.target = "_blank"; a.rel = "noopener";
    a.textContent = `u/${user}`; a.className = "cell-link"; return a;
  }
  function normalizeDigits(str) { return (str || "").replace(/\D+/g, ""); }
  function formatPhoneGeneral(digits) {
    const len = digits.length;
    if (len < 7 || len > 15) return "";
    if (len === 7) return `${digits.slice(0,3)}-${digits.slice(3)}`;
    if (len === 8) return `${digits.slice(0,4)}-${digits.slice(4)}`;
    if (len === 10) return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
    if (len === 11 && digits[0] === '1') return `+1 (${digits.slice(1,4)}) ${digits.slice(4,7)}-${digits.slice(7)}`;
    return digits;
  }
  function buildTelAnchor(raw) {
    const digits = normalizeDigits(raw);
    const disp = formatPhoneGeneral(digits);
    if (!disp) return null;
    let hrefDigits;
    if (digits.length === 11 && digits[0] === '1') hrefDigits = '+' + digits;
    else if (digits.length === 10) hrefDigits = '+1' + digits;
    else hrefDigits = '+' + digits;
    const a = document.createElement("a");
    a.href = `tel:${hrefDigits}`;
    a.target = "_self";
    a.textContent = disp;
    a.className = "cell-link";
    return a;
  }
  function buildWhatsappAnchor(raw){
    const digits = normalizeDigits(raw);
    const disp = formatPhoneGeneral(digits);
    if (!disp) return null;
    const a = document.createElement("a");
    a.href = `https://wa.me/${digits}`;
    a.target = "_blank";
    a.rel = "noopener";
    a.textContent = disp;
    a.className = "cell-link";
    return a;
  }

  function buildImageCell(tdImg, row, rIdx){
    if (!imgToggle.checked) return;
    if (tdImg._imgReady) return;
    tdImg._imgReady = true;

    const cands = imgCandCache.get(rIdx) || imageCandidates(row);
    imgCandCache.set(rIdx, cands);
    if (!cands.length) return;

    const sk  = document.createElement("div"); sk.className = "skeleton";
    const img = document.createElement("img"); img.className = "thumb"; img.loading="lazy"; img.decoding="async";

    let i = 0, timeoutId = null;
    function clearTimer(){ if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; } }
    function tryNext(){
      clearTimer();
      if (i >= cands.length) { sk.remove(); tdImg.textContent = ""; doneOne(); return; }
      const raw = cands[i++]; img._rawSrc = raw;
      const src = proxify(raw); img.src = ""; img.src = src;
      timeoutId = setTimeout(()=>img.onerror && img.onerror(), IMG_TIMEOUT_MS);
    }
    img.onerror = ()=>{ clearTimer(); tryNext(); };
    img.onload  = () => {
      clearTimer();
      if ((img.naturalWidth||0) < 48 || (img.naturalHeight||0) < 48) { tryNext(); return; }
      cacheSetGoodSrc(row, img._rawSrc || ""); sk.remove(); doneOne();
    };

    const starter = ()=>{ tryNext(); }; img._startLoading = starter; lazyImgObserver.observe(img);

    const landing = preferredLandingUrl(row);
    if (landing) {
      const a = document.createElement("a");
      a.href = landing; a.target = "_blank"; a.rel = "noopener"; a.title = "Open link";
      a.appendChild(sk); a.appendChild(img); tdImg.appendChild(a);
    } else {
      tdImg.appendChild(sk); tdImg.appendChild(img);
    }
  }

  function setSortBy(colLetter){
    if (!colLetter) { sortSpec = null; persistSort(GID, null); if (currentRows.length) render({ rows: currentRows, colCount: currentColCount }); return; }
    const idx = colLetterToIdx(colLetter);
    if (!sortSpec || sortSpec.colIdx !== idx) sortSpec = { colIdx: idx, dir: "asc" };
    else sortSpec.dir = (sortSpec.dir === "asc" ? "desc" : "asc");
    persistSort(GID, sortSpec);
    if (currentRows.length) render({ rows: currentRows, colCount: currentColCount });
  }
  function caretClassFor(colLetter){
    if (!sortSpec) return "sorted-none";
    const idx = colLetterToIdx(colLetter);
    if (sortSpec.colIdx !== idx) return "sorted-none";
    return sortSpec.dir === "asc" ? "sorted-asc" : "sorted-desc";
  }

  function updateDynamicIndices(rows){
    if (!rows || rows.length < 2) return;
    const header = rows[1] || [];
    for (let i=0;i<header.length;i++){
      const label = (header[i] || "").trim().toLowerCase();
      if (label === "location") LOC_COL_IDX = i;
      else if (label === "alternative location") ALT_LOC_COL_IDX = i;
      else if (label === "domme") DOMME_COL_IDX = i;
      else if (label === "images/aliases") ALIAS_COL_IDX = i;
      else if (label === "website") E_COL_IDX = i;
      else if (label === "link tree/all links") F_COL_IDX = i;
      else if (label === "x/bluesky") G_COL_IDX = i;
      else if (label === "verified?") H_COL_IDX = i;
      else if (label === "experience?") I_COL_IDX = i;
      else if (label === "price range?") J_COL_IDX = i;
      else if (label === "review/notes") REVIEW_COL_IDX = i;
      else if (label === "renown") RENOWN_COL_IDX = i;
      else if (label === "link to full review") FULL_REVIEW_COL_IDX = i;
      else if (label === "travels?") TRAVELS_COL_IDX = i;
      else if (label === "email") EMAIL_COL_IDX = i;
      else if (label === "reddit") P_COL_IDX = i;
      else if (label === "phone") Q_COL_IDX = i;
      else if (label === "services provided") SERVICES_COL_IDX = i;
      else if (label === "gender") GENDER_COL_IDX = i;
      else if (label === "scat link") SCAT_COL_IDX = i;
      else if (label === "fetlife") FETLIFE_COL_IDX = i;
      else if (label === "what's app" || label === "whats app" || label === "whatsapp") WHATSAPP_COL_IDX = i;
    }
  }

  function detectSocialKind(text){
    const t = (text || "").toLowerCase();
    if (!t) return null;
    if (/bsky\.app|bsky\.social/.test(t)) return "bluesky";
    if (/bluesky/.test(t)) return "bluesky";
    if (/twitter\.com|x\.com/.test(t)) return "x";
    if (t.startsWith("@")) return null;
    return null;
  }

  function extractHandleFromUrlish(text){
    if (!text) return "";
    const urlMatch = text.match(URL_RE);
    if (urlMatch) {
      try {
        const u = new URL(urlMatch[1]);
        const first = (u.pathname.split('/').filter(Boolean)[0] || "").replace(/^@/,"");
        if (first) return first;
      } catch {}
    }
    const at = text.match(/@([A-Za-z0-9._-]{1,50})/);
    if (at) return at[1];
    const parts = text.split('/').filter(Boolean);
    if (parts.length) return parts[parts.length - 1].replace(/^@/,"");
    return text.trim().replace(/^@/,"");
  }

  function formatLinksDisplay(raw){
    const pretty = prettyUrlText(raw);
    const m = raw && raw.match(URL_RE);
    let host = ""; let first = "";
    if (m) {
      try {
        const u = new URL(m[1]);
        host = (u.hostname || "").replace(/^www\./i,"");
        first = (u.pathname.split('/').filter(Boolean)[0] || "").replace(/^@/,"");
      } catch {}
    }
    if (/linktr\.ee/i.test(host)) return `Link Tree: ${first || pretty}`;
    if (/allmylinks\.com/i.test(host)) return `All my links: ${first || pretty}`;
    if (/beacons\.ai/i.test(host)) return `Links: Beacons- ${first || pretty}`;
    return pretty.replace(/\.com/gi," - ");
  }

  function formatSocialDisplay(raw){
    const kind = detectSocialKind(raw);
    const handle = extractHandleFromUrlish(raw);
    if (kind === "x") return `X: ${handle || prettyUrlText(raw)}`;
    const disp = handle ? `@${handle.replace(/^@/,"")}` : prettyUrlText(raw);
    return `Social: ${disp}`;
  }

  function formatScatDisplay(raw){
    const pretty = prettyUrlText(raw);
    const m = raw && raw.match(URL_RE);
    let host = ""; let handle = extractHandleFromUrlish(raw);
    if (m) {
      try { host = (new URL(m[1]).hostname || "").replace(/^www\./i,""); } catch {}
    }
    if (/scatbook/i.test(host)) return { text: `Scatbook: ${handle || pretty}`, dropLabel: true };
    if (/darkfans/i.test(host)) return { text: `Darkfans: ${handle || pretty}`, dropLabel: true };
    return { text: pretty.replace(/\.com/gi," - "), dropLabel: false };
  }

  function appendScamIcon(node, text){
    if (!/scam/i.test(text || "")) return;
    const warn = document.createElement("span");
    warn.textContent = " ‚ö†Ô∏è";
    warn.title = "Reports mention scam";
    node.appendChild(warn);
  }

  function render({ rows, colCount }){
    currentRows = rows; currentColCount = colCount;

    updateDynamicIndices(rows);

    let _sum = 0, _cnt = 0;
    for (let i=0; i<rows.length && i<ROW_CAP; i++){
      const r = rows[i];
      if (isOnlyColAText(r)) continue;
      const n = computePriceNumber(r[J_COL_IDX]);
      if (Number.isFinite(n)) { _sum += n; _cnt++; }
    }
    const _tabAvg = _cnt ? (_sum / _cnt) : NaN;

    imgCandCache.clear(); buildColgroup(); tbody.innerHTML = "";
    document.body.classList.toggle("hide-images", !imgToggle.checked);

    const groups = buildGroups(rows);
    const groupByHeaderIndex = new Map(groups.map(g => [g.headerIndex, g]));
    const sortedMemberLists = new Map();

    if (sortSpec && typeof sortSpec.colIdx === "number") {
      const cmp = comparator(sortSpec.colIdx, sortSpec.dir);
      for (const g of groups) {
        const sorted = [...g.members].sort(cmp);
        sortedMemberLists.set(g.headerIndex, sorted);
      }
    }

    function renderRowByIndex(rIdx){
      const row = rows[rIdx];
      if (isOnlyColAText(row)) {
        const g = groupByHeaderIndex.get(rIdx);
        const tr = document.createElement("tr");
        if (rIdx === 0) tr.classList.add("is-hidden");
        if (rIdx === 1) tr.classList.add("sticky-second");
        tr.classList.add("state-header");
        if (!g.collapsed) tr.classList.add("expanded");

        const td = document.createElement("td");
        td.colSpan = 1 + (MAX_SHOW_COL_IDX + 1);
        const bar = document.createElement("div"); bar.className = "state-bar";
        const chev = document.createElement("span"); chev.className = "chev";
        const label = document.createElement("span"); label.textContent = g.stateName;
        bar.appendChild(chev); bar.appendChild(label); td.appendChild(bar); tr.appendChild(td);
        tbody.appendChild(tr);

        tr.addEventListener("click", ()=>{
          g.collapsed = !g.collapsed;
          tr.classList.toggle("expanded", !g.collapsed);
          persistGroups(groups);
          const memberRows = tbody.querySelectorAll(`tr[data-group="${g.headerIndex}"]`);
          memberRows.forEach(mtr => {
            if (g.collapsed) {
              mtr.setAttribute("data-collapsed","true");
            } else {
              mtr.removeAttribute("data-collapsed");
              const idx = parseInt(mtr.getAttribute("data-row-index"), 10);
              const row = currentRows[idx];
              const tdImg = mtr.querySelector("td.imgCol");
              if (tdImg && imgToggle.checked) buildImageCell(tdImg, row, idx);
            }
          });
        });

        const members = sortedMemberLists.has(g.headerIndex) ? sortedMemberLists.get(g.headerIndex) : g.members;
        for (const mi of members) renderDataRow(mi, g);
        return;
      }

      const belongs = groups.find(g => g.members.includes(rIdx));
      if (!belongs) renderDataRow(rIdx, null);
    }

    function renderDataRow(rIdx, groupObj){
      const row = rows[rIdx];
      const tr = document.createElement("tr");
      tr.setAttribute("data-row-index", String(rIdx));
      if (rIdx === 0) tr.classList.add("is-hidden");
      if (rIdx === 1) tr.classList.add("sticky-second");

      if (groupObj) { tr.setAttribute("data-group", groupObj.headerIndex); if (groupObj.collapsed) tr.setAttribute("data-collapsed","true"); }

      const tdImg = document.createElement("td"); tdImg.className = "imgCol";
      const groupIsCollapsed = !!(groupObj && groupObj.collapsed);
      if (imgToggle.checked && !groupIsCollapsed) { buildImageCell(tdImg, row, rIdx); }
      tr.appendChild(tdImg);

      for (let c = 0; c <= MAX_SHOW_COL_IDX; c++) {
        const td  = document.createElement("td");

        if (isHiddenColIndex(c)) {
          td.style.display = "none";
          tr.appendChild(td);
          continue;
        }

        const txt = row[c] ?? "";

        if (rIdx === 1) {
          if (c === E_COL_IDX) {
            td.textContent = "Links";
            tr.appendChild(td);
            continue;
          }
          if (c === EMAIL_COL_IDX) {
            td.textContent = "Contact info";
            tr.appendChild(td);
            continue;
          }
          if (c === F_COL_IDX || c === G_COL_IDX || c === SCAT_COL_IDX || c === FETLIFE_COL_IDX ||
              c === RENOWN_COL_IDX || c === FULL_REVIEW_COL_IDX || c === TRAVELS_COL_IDX ||
              c === P_COL_IDX || c === Q_COL_IDX || c === ALIAS_COL_IDX || c === GENDER_COL_IDX ||
              c === WHATSAPP_COL_IDX) {
            td.textContent = "";
            tr.appendChild(td);
            continue;
          }

          const label = (txt || "").trim();
          if (SORTABLE_HEADERS.has(label)) {
            const colLetter = SORTABLE_HEADERS.get(label);
            const span = document.createElement("span");
            span.className = `hdr-sort ${caretClassFor(colLetter)}`;
            span.title = "Click to sort within each state";
            const caret = document.createElement("span"); caret.className = "sort-caret";
            span.textContent = label + " "; span.appendChild(caret);
            span.addEventListener("click", ()=> setSortBy(colLetter));
            td.appendChild(span); tr.appendChild(td); continue;
          }

          td.textContent = txt;
          tr.appendChild(td);
          continue;
        }

        /* Domme + Aliases + Gender stacked */
        if (c === DOMME_COL_IDX && rIdx > 1) {
          const domme = row[DOMME_COL_IDX] || "";
          const alias = ALIAS_COL_IDX >= 0 ? (row[ALIAS_COL_IDX] || "") : "";
          const gender = GENDER_COL_IDX >= 0 ? (row[GENDER_COL_IDX] || "") : "";
          const block = document.createElement("div");
          block.className = "stack-block";
          if (domme.trim()) {
            const d = document.createElement("div");
            d.textContent = domme;
            d.style.fontWeight = "700";
            d.style.color = "#000";
            block.appendChild(d);
          }
          if (alias.trim()) {
            const a = document.createElement("div");
            a.className = "stack-muted";
            a.textContent = `(${alias.trim()})`;
            block.appendChild(a);
          }
          if (gender.trim()) {
            const gLine = document.createElement("div");
            gLine.className = "stack-muted";
            gLine.textContent = `(${gender.trim()})`;
            block.appendChild(gLine);
          }
          td.appendChild(block);
          tr.appendChild(td);
          continue;
        }

        /* Alternative Location + Travels? stacked with mapping */
        if (c === ALT_LOC_COL_IDX && rIdx > 1) {
          const alt = row[ALT_LOC_COL_IDX] || "";
          let trav = TRAVELS_COL_IDX >= 0 ? (row[TRAVELS_COL_IDX] || "") : "";
          let travDisplay = trav.trim();
          const tNorm = travDisplay.toLowerCase();
          if (tNorm === "yes") travDisplay = "FMTY";
          else if (tNorm === "no") travDisplay = "Does not travel";

          const block = document.createElement("div");
          block.className = "stack-block";
          if (alt.trim()) {
            const l = document.createElement("div");
            l.textContent = alt;
            block.appendChild(l);
          }
          if (travDisplay.trim()) {
            const tline = document.createElement("div");
            tline.className = "stack-muted";
            tline.textContent = `(${travDisplay.trim()})`;
            block.appendChild(tline);
          }
          td.appendChild(block);
          tr.appendChild(td);
          continue;
        }

        /* Combined Links block */
        if (c === E_COL_IDX && rIdx > 1) {
          const website = row[E_COL_IDX] || "";
          const links = F_COL_IDX >= 0 ? (row[F_COL_IDX] || "") : "";
          const social = G_COL_IDX >= 0 ? (row[G_COL_IDX] || "") : "";
          const scat = SCAT_COL_IDX >= 0 ? (row[SCAT_COL_IDX] || "") : "";
          const fet = FETLIFE_COL_IDX >= 0 ? (row[FETLIFE_COL_IDX] || "") : "";
          const block = document.createElement("div");
          block.className = "stack-block";

          function addLine(label, value){
            if (!value || !String(value).trim()) return;
            const line = document.createElement("div");
            line.className = "stack-line";
            const l = document.createElement("span");
            l.className = "stack-label";
            l.textContent = label;
            const v = document.createElement("span");
            v.className = "stack-value";
            const frag = linkifyWithMore(value, {alwaysShow:false, pretty:true});
            if (frag) v.appendChild(frag); else v.textContent = value;
            line.appendChild(l); line.appendChild(v);
            block.appendChild(line);
          }

          function addPill(text, url, color){
            if (!text || !url) return;
            const line = document.createElement("div");
            line.className = "stack-line";
            const v = document.createElement("span");
            v.className = "stack-value";
            const pill = document.createElement("a");
            pill.href = url;
            pill.target = "_blank";
            pill.rel = "noopener";
            pill.className = `pill ${color || ""}`;
            pill.textContent = text;
            v.appendChild(pill);
            line.appendChild(v);
            block.appendChild(line);
          }

            if (website.trim()) {
              const url = firstUrl(website) || website.trim();
              addPill(prettyUrlText(url), url, "red");
            }

          if (links.trim()) {
            const url = firstUrl(links) || links.trim();
            addPill(formatLinksDisplay(links), url, "green");
          }

          if (social.trim()) {
            const url = firstUrl(social) || social.trim();
            addPill(formatSocialDisplay(social), url, "blue");
          }

            if (scat.trim()) {
              const url = firstUrl(scat) || scat.trim();
              const scatFmt = formatScatDisplay(scat);
              if (scatFmt.dropLabel) {
                addPill(scatFmt.text, url, "brown");
              } else {
                addPill(`Scat link: ${scatFmt.text}`, url, "brown");
              }
            }
            if (fet.trim()) {
              const url = firstUrl(fet) || fet.trim();
              addPill(prettyUrlText(url), url, "dark-red");
            }

          td.appendChild(block);
          tr.appendChild(td);
          continue;
        }

        /* Combined Contact info */
        if (c === EMAIL_COL_IDX && rIdx > 1) {
          const emailRaw = row[EMAIL_COL_IDX] || "";
          const redditRaw = P_COL_IDX >= 0 ? (row[P_COL_IDX] || "") : "";
          const phoneRaw = Q_COL_IDX >= 0 ? (row[Q_COL_IDX] || "") : "";
          const whatsappRaw = WHATSAPP_COL_IDX >= 0 ? (row[WHATSAPP_COL_IDX] || "") : "";
          const block = document.createElement("div");
          block.className = "stack-block";

          function addMulti(labelBase, raw, builder){
            if (!raw) return;
            const parts = String(raw).split(/[;,]/);
            let idx = 0;
            for (const part of parts) {
              const val = part.trim();
              if (!val) continue;
              const node = builder(val);
              if (!node) continue;
              const line = document.createElement("div");
              line.className = "stack-line";
              const l = document.createElement("span");
              l.className = "stack-label";
              l.textContent = idx === 0 ? labelBase + ":" : labelBase + " alt:";
              const v = document.createElement("span");
              v.className = "stack-value";
              v.appendChild(node);
              line.appendChild(l); line.appendChild(v);
              block.appendChild(line);
              idx++;
            }
          }

          addMulti("Phone", phoneRaw, (val)=>buildTelAnchor(val));
          addMulti("WhatsApp", whatsappRaw, (val)=>buildWhatsappAnchor(val));
          addMulti("Email", emailRaw, (val)=>{
            if (!/@/.test(val)) return null;
            const a = document.createElement("a");
            a.href = `mailto:${val.trim()}`;
            a.textContent = val.trim();
            a.className = "cell-link";
            return a;
          });
          addMulti("Reddit", redditRaw, (val)=>{
            const node = buildRedditLink(val);
            if (!node) return null;
            node.classList.add("pill","orange");
            return node;
          });

          td.appendChild(block);
          tr.appendChild(td);
          continue;
        }

        /* Verified? + Renown stacked with EMOJIS ABOVE text */
        if (c === H_COL_IDX && rIdx > 1) {
          const verRaw = row[H_COL_IDX] || "";
          const ren = RENOWN_COL_IDX >= 0 ? (row[RENOWN_COL_IDX] || "") : "";
          const block = document.createElement("div");
          block.className = "stack-block";

          if (verRaw.trim()) {
            const vLower = verRaw.toLowerCase();
            let emojis = "";
            if (vLower.includes("needs review") || vLower.includes("needs verification")) emojis += "‚ö†Ô∏è";
            if (vLower.includes("scam")) emojis += "üö´";
            if (vLower.includes("verified")) emojis += "üèÖ";
            if (vLower.includes("admin verified")) emojis += "üëÅÔ∏è";
            if (vLower.includes("reddit verified")) emojis += "üôã";
            if (vLower.includes("fetlife verified")) emojis += "üï∏Ô∏è";
            if (vLower.includes("seems legit")) emojis += "ü§∑";

            if (emojis) {
              const emojiRow = document.createElement("div");
              emojiRow.className = "verified-emoji-row";
              emojiRow.textContent = emojis;
              block.appendChild(emojiRow);
            }

            const textRow = document.createElement("div");
            textRow.textContent = verRaw;
            block.appendChild(textRow);
          }

          if (ren.trim()) {
            const r = document.createElement("div");
            r.className = "stack-muted";
            r.textContent = ren;
            appendScamIcon(r, ren);
            block.appendChild(r);
          }
          td.appendChild(block);
          tr.appendChild(td);
          continue;
        }

        /* Experience? + Full Review button stacked */
        if (c === I_COL_IDX && rIdx > 1) {
          let exp = row[I_COL_IDX] || "";
          const linkReview = FULL_REVIEW_COL_IDX >= 0 ? (row[FULL_REVIEW_COL_IDX] || "") : "";
          const block = document.createElement("div");
          block.className = "stack-block";

          if (!exp.trim()) {
            exp = "Needs review!";
          }

          const tExp = exp.toString().trim().toLowerCase();
          const needsReview = tExp.includes("needs review");
          let iconSpan = null;
          if (tExp === "positive") {
            iconSpan = document.createElement("span");
            iconSpan.className = "sentiment";
            iconSpan.textContent = "üëç";
            iconSpan.title = "Positive";
          } else if (tExp === "negative") {
            iconSpan = document.createElement("span");
            iconSpan.className = "sentiment";
            iconSpan.textContent = "üëé";
            iconSpan.title = "Negative";
          } else if (tExp === "neutral") {
            iconSpan = document.createElement("span");
            iconSpan.className = "sentiment";
            iconSpan.textContent = "ü§∑";
            iconSpan.title = "Neutral";
          }

          if (iconSpan || needsReview) {
            const line = document.createElement("div");
            line.className = "stack-line";
            const lbl = document.createElement("span");
            lbl.className = "stack-label";
            lbl.textContent = "Experience:";
            const v = document.createElement("span");
            v.className = "stack-value";
            if (iconSpan) v.appendChild(iconSpan);
            const textSpan = document.createElement("span");
            const needsReviewText = needsReview ? `${exp}‚ùì` : exp;
            textSpan.textContent = iconSpan ? ` ${needsReviewText}` : needsReviewText;
            appendScamIcon(textSpan, exp);
            v.appendChild(textSpan);
            line.appendChild(lbl); line.appendChild(v);
            block.appendChild(line);
          } else if (exp.trim()) {
            const line = document.createElement("div");
            line.textContent = exp;
            appendScamIcon(line, exp);
            block.appendChild(line);
          }

          if (linkReview && URL_RE.test(linkReview)) {
            const m = linkReview.match(URL_RE);
            const url = m ? m[1] : null;
            if (url) {
              const line = document.createElement("div");
              line.className = "stack-line";
              const v = document.createElement("span");
              v.className = "stack-value";
              const btn = document.createElement("a");
              btn.href = url;
              btn.target = "_blank";
              btn.rel = "noopener";
              btn.textContent = "Full Review";
              btn.className = "btn small";
              v.appendChild(btn);
              line.appendChild(v);
              block.appendChild(line);
            }
          }

          td.appendChild(block);
          tr.appendChild(td);
          continue;
        }

        /* Price + badge */
        if (c === J_COL_IDX && rIdx > 1) {
          const txtPrice = txt;
          const n = computePriceNumber(txtPrice);
          const cleaned = Number.isFinite(n) ? `$${Math.round(n)}` : (txtPrice || "").replace(/(?:high|mid|low|unknown|\?)/gi,'').trim() || "Unknown";
          const avg = render._tabAvg;
          let band = "‚Äî";
          if (Number.isFinite(n) && Number.isFinite(avg)) {
            const diff = n - avg;
            band = Math.abs(diff) <= 150 ? "average" : (diff > 150 ? "‚Üë above average" : "‚Üì below average");
          }
          const wrap = document.createElement("div");
          const main = document.createElement("span"); main.textContent = cleaned;
          const badge = document.createElement("span"); badge.className = "price-badge"; badge.textContent = ` ${band}`;
          wrap.appendChild(main); wrap.appendChild(badge);
          td.appendChild(wrap);
          tr.appendChild(td);
          continue;
        }

        /* Services Provided */
        if (c === SERVICES_COL_IDX && rIdx > 1) {
          buildServicesCell(td, txt);
          tr.appendChild(td);
          continue;
        }

        /* Review/notes with scam icon + linkify */
        if (c === REVIEW_COL_IDX && rIdx > 1) {
          const wrap = document.createElement("div");
          wrap.className = "clamp-wrap clamp-3";
          const frag = linkifyWithMore(txt);
          if (frag) wrap.appendChild(frag); else wrap.textContent = txt;
          appendScamIcon(wrap, txt);
          td.appendChild(wrap);
          requestAnimationFrame(()=>{
            if (wrap.scrollHeight > wrap.clientHeight + 1) {
              const btn = document.createElement("span");
              btn.className = "moreless"; btn.textContent = " More";
              btn.addEventListener("click", ()=>{
                wrap.classList.toggle("clamp-3");
                btn.textContent = wrap.classList.contains("clamp-3") ? " More" : " Less";
              });
              td.appendChild(btn);
            }
          });
          tr.appendChild(td);
          continue;
        }

        const frag = linkifyWithMore(txt);
        if (frag) td.appendChild(frag); else makeTextCell(td, txt, 3);

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    render._tabAvg = _tabAvg;

    for (let i=0; i<rows.length && i<ROW_CAP; i++){
      const row = rows[i];
      if (isOnlyColAText(row)) {
        renderRowByIndex(i);
      } else {
        const inGroup = groups.find(g => g.members.includes(i));
        if (!inGroup) renderDataRow(i, null);
      }
    }

    rowTextIndex.clear();
    tbody.querySelectorAll('tr[data-row-index]').forEach(tr=>{
      const idx = parseInt(tr.getAttribute('data-row-index'), 10);
      const row = currentRows[idx] || [];
      const txt = row.slice(0, MAX_SHOW_COL_IDX + 1).join(" ").toLowerCase();
      rowTextIndex.set(idx, txt);
    });

    expandAllBtn.onclick = () => {
      groups.forEach(g => g.collapsed = false);
      persistGroups(groups);
      tbody.querySelectorAll("tr.state-header").forEach(tr => tr.classList.add("expanded"));
      const members = tbody.querySelectorAll('tr[data-group]');
      members.forEach(mtr => {
        mtr.removeAttribute("data-collapsed");
        const idx = parseInt(mtr.getAttribute("data-row-index"), 10);
        const row = currentRows[idx];
        const tdImg = mtr.querySelector("td.imgCol");
        if (tdImg && imgToggle.checked) buildImageCell(tdImg, row, idx);
      });
    };
    collapseAllBtn.onclick = () => {
      groups.forEach(g => g.collapsed = true);
      persistGroups(groups);
      tbody.querySelectorAll("tr.state-header").forEach(tr => tr.classList.remove("expanded"));
      tbody.querySelectorAll('tr[data-group]').forEach(tr => tr.setAttribute("data-collapsed","true"));
    };

    meta.textContent = `src=gviz ‚Ä¢ gid=${GID} ‚Ä¢ rows: ${rows.length} (showing ${Math.min(rows.length, ROW_CAP)}) ‚Ä¢ cols: ${colCount} ‚Ä¢ ${new Date().toLocaleTimeString()}`;

    restoreScrollFor(GID);
  }

  function applySearch(q, fromRender=false){
    lastQuery = (q || "").trim().toLowerCase();
    const isActive = !!lastQuery;

    const headerRows = tbody.querySelectorAll("tr.state-header");
    const dataRows   = tbody.querySelectorAll('tr[data-row-index]');

    if (isActive) {
      headerRows.forEach(h => h.classList.add("expanded"));
      tbody.querySelectorAll("tr[data-group]").forEach(tr => tr.removeAttribute("data-collapsed"));

      let shown = 0;
      dataRows.forEach(tr=>{
        const idx = parseInt(tr.getAttribute("data-row-index"),10);
        const hay = rowTextIndex.get(idx) || "";
        const match = hay.includes(lastQuery);
        tr.classList.toggle("search-row-hide", !match);
        if (match) shown++;
      });

      const sticky = tbody.querySelector('tr[data-row-index="1"]');
      if (sticky) sticky.classList.remove("search-row-hide");
      tbody.querySelectorAll("tr.is-hidden").forEach(tr => tr.classList.add("search-row-hide"));

      meta.textContent = meta.textContent.replace(/‚Ä¢ matches: \d+/, "");
      meta.textContent += ` ‚Ä¢ matches: ${shown}`;
    } else {
      tbody.querySelectorAll("tr").forEach(tr => tr.classList.remove("search-row-hide"));
      if (!fromRender && currentRows.length) render({ rows: currentRows, colCount: currentColCount });
      meta.textContent = meta.textContent.replace(/‚Ä¢ matches: \d+/, "");
    }
  }
  const debouncedSearch = debounce(()=>applySearch(searchBox.value), 120);

  function saveScrollFor(gid, top){ try { localStorage.setItem(SCROLL_KEY_PREFIX + gid, String(top|0)); } catch {} }
  function loadScrollFor(gid){ try { const v = localStorage.getItem(SCROLL_KEY_PREFIX + gid); return v ? parseInt(v, 10) || 0 : 0; } catch { return 0; } }
  const debouncedSaveScroll = debounce(()=>{ saveScrollFor(GID, scrollWrap.scrollTop || 0); }, 120);

  async function load(){
    saveScrollFor(GID, scrollWrap.scrollTop || 0);
    meta.textContent = "loading‚Ä¶";
    try {
      const pack = await fetchRect();
      render(pack);
      if (lastQuery) applySearch(lastQuery, true);
    } catch(e){
      console.error(e);
      meta.textContent = "Error loading GViz (check sharing / range).";
    }
  }
  let timer=null;
  function startPolling(){ if (timer) clearInterval(timer); timer = setInterval(load, POLL_MS); }

  $$(".button-row .btn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      saveScrollFor(GID, scrollWrap.scrollTop || 0);
      $$(".button-row .btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      GID = btn.dataset.gid;
      try { localStorage.setItem(ACTIVE_GID_KEY, GID); } catch {}
      sortSpec = loadSort(GID);
      await load();
      if (lastQuery) applySearch(lastQuery);
    });
  });

  searchBox.addEventListener("input", debouncedSearch);
  clearSearchBtn.addEventListener("click", ()=>{
    searchBox.value = "";
    applySearch("");
    searchBox.focus();
  });

  scrollWrap.addEventListener("scroll", debouncedSaveScroll);

  imgToggle.addEventListener("change", ()=>{
    saveShowImages(imgToggle.checked);
    if (currentRows.length) {
      const prevTop = scrollWrap.scrollTop || 0;
      render({ rows: currentRows, colCount: currentColCount });
      scrollWrap.scrollTop = prevTop;
    }
  });

  resetSortBtn.addEventListener("click", ()=>{
    sortSpec = null; persistSort(GID, null);
    if (currentRows.length) { const prevTop = scrollWrap.scrollTop || 0; render({ rows: currentRows, colCount: currentColCount }); scrollWrap.scrollTop = prevTop; }
  });

  downloadCsvBtn.addEventListener("click", ()=>{
    if (!currentRows || !currentRows.length){
      alert("No data loaded yet.");
      return;
    }
    const tabName = (TABS.find(t => t.gid === GID)?.name || "data").toLowerCase().replace(/\s+/g,'-');
    const rows = currentRows.map(r => r.slice(0, MAX_SHOW_COL_IDX + 1));
    downloadCSV(`ftt-${tabName}.csv`, rows);
  });

  function restoreScrollFor(gid){
    const targetTop = loadScrollFor(gid);
    requestAnimationFrame(()=>requestAnimationFrame(()=>{ scrollWrap.scrollTop = targetTop; }));
  }

  (async function boot(){
    try {
      const stored = localStorage.getItem(ACTIVE_GID_KEY);
      if (stored && $(`.button-row .btn[data-gid="${stored}"]`)) {
        GID = stored;
        $$(".button-row .btn").forEach(b=>b.classList.toggle("active", b.dataset.gid === GID));
      }
    } catch {}
    const v = localStorage.getItem("ftt-show-images");
    const showImages = (v === null ? true : v === "true");
    imgToggle.checked = showImages;
    document.body.classList.toggle("hide-images", !showImages);

    sortSpec = loadSort(GID);

    await load();
    startPolling();
  })();
  </script>
</body>
</html>
