<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FTT Big List</title>

  <link rel="preconnect" href="https://unavatar.io" crossorigin>
  <link rel="preconnect" href="https://www.google.com" crossorigin>
  <link rel="preconnect" href="https://images.weserv.nl" crossorigin>
  <link rel="dns-prefetch" href="//unavatar.io">
  <link rel="dns-prefetch" href="//images.weserv.nl">
  <link rel="dns-prefetch" href="//www.google.com">

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    :root{
      --brand:#0078d7; --bg:#f4f7fa; --panel:#fff; --text:#222;
      --line:#e9eef4; --line-2:#e0e6ee; --accent:#0063b1; --state:#000;
    }
    body { margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; flex-direction:column; }

    header { display:grid; gap:8px; padding:10px 12px; background:var(--brand); color:#fff; box-shadow:0 1px 2px rgba(0,0,0,.08); }
    header .top { display:flex; gap:12px; align-items:center; }
    h1 { margin:0; font-size:15px; font-weight:800; line-height:1.1; letter-spacing:.2px; }
    .meta { margin-left:auto; font-size:12px; opacity:.95; background:#ffffff1a; padding:4px 8px; border-radius:8px; }

    .button-row { display:flex; flex-wrap:wrap; gap:6px; }
    .btn { color:#fff; background:#0063b1; border:0; border-radius:10px; padding:.40rem .65rem; font-weight:700; font-size:13px; cursor:pointer; transition:transform .05s ease, filter .2s ease; }
    .btn:active{ transform: translateY(1px); }
    .btn.us{background:#0078d7}.btn.canada{background:#d83b01}.btn.samerica{background:#107c10}
    .btn.europe{background:#6b46c1}.btn.eastasia{background:#e81123}.btn.mideast{background:#ffb900;color:#333}
    .btn.active{outline:2px solid #fff; outline-offset:1px; filter:brightness(1.06)}

    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; font-size:12px; }
    .controls input[type="search"]{ padding:8px 10px; border-radius:10px; border:1px solid #c8d7eb; min-width:260px; outline:none; background:#fff; }
    .controls .btn { font-size:12px; padding:.45rem .65rem; border-radius:10px; border:none; }

    main { display:flex; flex-direction:column; }
    .table-wrap { height: calc(100vh - 154px); overflow:auto; background:var(--panel); border-top:1px solid var(--line); border-bottom:1px solid var(--line); }

    table { border-collapse:separate; border-spacing:0; width:100%; table-layout:fixed; font-size:14px; min-width:2300px; }
    tbody td { border-bottom:1px solid #f0f3f6; padding:8px 10px; vertical-align:top;
      white-space:normal; overflow-wrap:break-word; word-break:normal; hyphens:manual; line-height:1.35; background:var(--panel); }
    tbody tr:nth-child(2n){ background:#fafcff; }

    tbody tr.is-hidden{ display:none; }
    tbody tr.sticky-second td { position:sticky; top:0; z-index:4; background:linear-gradient(#f7fafc,#eef3f9); border-bottom:2px solid var(--line-2); }

    .sticky-second .hdr-sort{ display:inline-flex; align-items:center; gap:6px; font-weight:800; cursor:pointer; user-select:none; padding:2px 4px; border-radius:8px; }
    .sticky-second .hdr-sort:hover{ background:#e9eef7; }
    .sort-caret{ font-size:12px; opacity:.75; }
    .sorted-asc .sort-caret::after{ content:"▲"; }
    .sorted-desc .sort-caret::after{ content:"▼"; }
    .sorted-none .sort-caret::after{ content:"↕"; opacity:.5; }

    tr.state-header>td{ background:var(--state)!important; color:#fff!important; font-weight:800; letter-spacing:.2px; border-bottom:2px solid #111; position:sticky; top:40px; z-index:3; }
    tr.state-header .state-bar{ display:flex; align-items:center; gap:10px; cursor:pointer; padding:6px 0; }
    .chev{ width:0; height:0; border-left:6px solid currentColor; border-top:4px solid transparent; border-bottom:4px solid transparent; transition:transform .15s ease; }
    .expanded .chev{ transform:rotate(90deg); }
    tr[data-collapsed="true"]{ display:none; }

    .imgCol{ width:160px; }
    .thumb{ width:120px; height:120px; border-radius:12px; border:1px solid #ececec; object-fit:cover; display:block; background:#f1f1f1; }
    .skeleton{ width:120px; height:120px; background:linear-gradient(90deg,#eee,#f5f5f5,#eee); background-size:200% 100%; animation:shimmer 1s linear infinite; border-radius:12px; border:1px solid #ececec; }
    @keyframes shimmer{0%{background-position:0% 0}100%{background-position:200% 0}}
    .hide-images .imgCol{ display:none; }

    td a{ white-space:nowrap; display:inline-block; max-width:100%; overflow:hidden; text-overflow:ellipsis; }
    .cell-link{ color:inherit; text-decoration:underline; }
    .full-url{ display:none; margin-top:6px; font-size:12px; color:#333; word-break:break-all; white-space:normal; background:#f6f8fb; border:1px solid #e5ebf3; border-radius:8px; padding:6px; }
    .show-full .full-url{ display:block; }

    .clamp-wrap{ display:-webkit-box; -webkit-box-orient:vertical; overflow:hidden; }
    .clamp-3{ -webkit-line-clamp:3; }
    .moreless{ display:inline-block; margin-top:6px; font-size:12px; color:var(--accent); cursor:pointer; user-select:none; }

    .search-row-hide{ display:none!important; }
    .sentiment{ font-size:18px; line-height:1; }

    .footer-actions{ padding:8px 12px; display:flex; gap:8px; align-items:center; color:#4b5563; font-size:12px;}
    .linkish{ color:#0a5a7a; cursor:pointer; text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <div class="top">
      <h1>FTT Big List</h1>
      <div class="meta" id="meta">loading…</div>
    </div>

    <div class="button-row" role="navigation" aria-label="Tabs">
      <button class="btn us active" data-gid="0">United States</button>
      <button class="btn canada" data-gid="918890863">Canada</button>
      <button class="btn samerica" data-gid="506975496">South America + Caribbean</button>
      <button class="btn europe" data-gid="1560092023">Europe + Nordic</button>
      <button class="btn eastasia" data-gid="1966795654">East Asia + Oceania + Australia</button>
      <button class="btn mideast" data-gid="1604960979">Middle East</button>
    </div>

    <div class="controls">
      <input id="searchBox" type="search" placeholder="Search…" />
      <button id="clearSearch" class="btn" style="background:#666">Clear</button>

      <label class="switch" title="Toggle row thumbnails">
        <input id="imgToggle" type="checkbox" />
        Show images
      </label>

      <button id="expandAll" class="btn" style="background:#3aa655">Expand all</button>
      <button id="collapseAll" class="btn" style="background:#b83d3d">Collapse all</button>
    </div>
  </header>

  <main>
    <div class="table-wrap" id="scrollWrap">
      <table id="tbl" aria-live="polite">
        <colgroup id="colg"></colgroup>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="footer-actions">
      <span class="linkish" id="resetSort">Reset sorting</span>
    </div>
  </main>

  <script>
  /** ==== CONFIG ==== */
  const FILE_ID = "1hse75kxI9Gcb7g_tc9LOZ5dYVkFgDcNCrLKyq03cnHg";
  let   GID     = "0";
  const RANGE   = "A1:AA50000";
  const MAX_SHOW_COL_LETTER = "S";
  const MAX_SHOW_COL_IDX = colLetterToIdx(MAX_SHOW_COL_LETTER);

  const ACTIVE_GID_KEY = "ftt-active-gid";
  const SCROLL_KEY_PREFIX = "ftt-scroll:";
  const SORT_KEY_PREFIX   = "ftt-sort:";

  /* Wider columns: add Website (E) */
  const WIDE_COLS = ["E","K","R"];
  const WIDE_IDX  = WIDE_COLS.map(colLetterToIdx);

  /* Image pref column (V) */
  const IMAGE_PREF_COL_IDX = colLetterToIdx("V");

  /* Column indexes (A=0) */
  const E_COL_IDX = 4, F_COL_IDX = 5, G_COL_IDX = 6, H_COL_IDX = 7, I_COL_IDX = 8, J_COL_IDX = 9, P_COL_IDX = 15, Q_COL_IDX = 16;

  /* Insert a computed Price band column immediately after J */
  const HAS_PRICE_BAND_COL = true;
  const PRICE_BAND_WIDTH   = 160;

  /* Sortable header labels on the sticky header row */
  const SORTABLE_HEADERS = new Map([
    ["Location","A"],["Alternative Location","B"],["Domme","C"],
    ["Verified?","H"],["Experience?","I"],["Price range?","J"],
  ]);

  let POLL_MS = 120000;
  let ROW_CAP = 2000;
  const THUMB_PX = 120;

  const MAX_CONCURRENT_IMG = 8;
  const IMG_TIMEOUT_MS = 3000;
  const LAZY_ROOT_MARGIN = '1200px 0px';

  /** ==== DOM ==== */
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const tbody = $("#tbody");
  const colg  = $("#colg");
  const meta  = $("#meta");
  const imgToggle = $("#imgToggle");
  const expandAllBtn = $("#expandAll");
  const collapseAllBtn = $("#collapseAll");
  const searchBox = $("#searchBox");
  const clearSearchBtn = $("#clearSearch");
  const resetSortBtn = $("#resetSort");
  const scrollWrap = $("#scrollWrap");

  /** ==== State ==== */
  let currentRows = [];
  let currentColCount = 0;
  let sortSpec = null;
  let lastQuery = "";
  let imgCandCache = new Map();
  let rowTextIndex = new Map();

  /** ==== Concurrency limiter for images ==== */
  let inflight = 0;
  const pendingStarts = [];
  function schedule(startFn){ if (inflight < MAX_CONCURRENT_IMG){ inflight++; startFn(); } else { pendingStarts.push(startFn); } }
  function doneOne(){ inflight = Math.max(0, inflight - 1); if (pendingStarts.length){ const fn = pendingStarts.shift(); inflight++; fn(); } }

  /** ==== Lazy image observer ==== */
  const lazyImgObserver = new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      if (!entry.isIntersecting) return;
      const starter = entry.target._startLoading;
      if (starter) schedule(starter);
      lazyImgObserver.unobserve(entry.target);
    });
  }, { root: scrollWrap, rootMargin: LAZY_ROOT_MARGIN, threshold: 0.01 });

  /** ==== Utilities ==== */
  function colLetterToIdx(letter){ let n=0; for(let i=0;i<letter.length;i++) n=n*26+(letter.charCodeAt(i)-64); return n-1; }
  const URL_RE = /(https?:\/\/[^\s)'"<>]+)/i;
  const IMG_EXT_RE   = /\.(png|jpe?g|gif|webp|avif|svg)(\?.*)?$/i;
  const IMG_HOST_HINT= /(twimg\.com|fbcdn\.net|cdn|images|media|imgur|ggpht\.com|pinimg\.com)/i;
  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

  function extractNumbers(s){
    if (!s) return [];
    const m = String(s).replace(/,/g,'').match(/\d+(\.\d+)?/g);
    return m ? m.map(x=>parseFloat(x)) : [];
  }
  function computePriceNumber(s){
    const arr = extractNumbers(s);
    if (!arr.length) return NaN;
    if (arr.length === 1) return arr[0];
    const sum = arr.reduce((a,b)=>a+b,0);
    return sum / arr.length;
  }
  function norm(s){ return (s||"").toString().trim().toLowerCase(); }

  function firstUrl(text){ const m=(text||"").match(URL_RE); return m?m[1]:""; }
  function preferredLandingUrl(row){ return firstUrl(row[4]) || firstUrl(row[6]) || ""; }
  function isOnlyColAText(row){ const a=(row[0]||"").trim(); if(!a) return false; for(let i=1;i<row.length;i++) if((row[i]||"").trim()!=="") return false; return true; }

  function extractDomain(url){ try { return new URL(url).hostname.replace(/^www\./i,''); } catch { return ""; } }
  function prettyUrlText(url){ try { const u=new URL(url); return (u.hostname||"").replace(/^www\./i,'') || url; } catch { return String(url).replace(/^https?:\/\//i,'').replace(/^www\./i,'').replace(/\/$/,''); } }

  function linkifyWithMore(text, {alwaysShow=false, pretty=false} = {}){
    const m = text && text.match(URL_RE); if (!m) return null;
    const url = m[1];
    const frag = document.createDocumentFragment();
    const a = document.createElement("a");
    a.href = url; a.target = "_blank"; a.rel = "noopener";
    a.textContent = pretty ? prettyUrlText(url) : text;
    a.className = "cell-link";
    frag.appendChild(a);
    if (alwaysShow || url.length > 60) {
      const btn = document.createElement("span"); btn.className = "moreless"; btn.textContent = " More";
      const wrap = document.createElement("div"); wrap.className = "full-url"; wrap.textContent = url;
      btn.addEventListener("click", ()=>{
        const td = btn.parentElement; td.classList.toggle("show-full");
        btn.textContent = td.classList.contains("show-full") ? " Less" : " More";
      });
      frag.appendChild(btn); frag.appendChild(wrap);
    }
    return frag;
  }

  function unavatarForUrlishSkippingTwitter(txt){
    const m = txt && txt.match(URL_RE); if (!m) return "";
    const host = extractDomain(m[1]); if (!host || /(^|\.)x\.com$|(^|\.)twitter\.com$/i.test(host)) return "";
    return host ? `https://unavatar.io/${encodeURIComponent(host)}?fallback=false` : "";
  }
  function faviconForUrlishSkippingTwitter(txt){
    const m = txt && txt.match(URL_RE); if (!m) return "";
    const host = extractDomain(m[1]); if (!host || /(^|\.)x\.com$|(^|\.)twitter\.com$/i.test(host)) return "";
    return host ? `https://www.google.com/s2/favicons?domain=${encodeURIComponent(host)}&sz=128` : "";
  }

  function imageCandidates(row){
    const out = [];
    const vtxt = row[IMAGE_PREF_COL_IDX] || "";
    const vm = vtxt.match(URL_RE);
    if (vm){
      const v = vm[1];
